extends ../../layout.pug


block content
    .content-header
        .container-fluid
            .row.mb-3.mt-3
            .col-sm-6
                h1.m-0.text-dark All Cards
    .content
        .container-fluid
            if successes
                for success in successes
                    div.alert.alert-success #{ success }
            if errors
                for error, i in errors
                    div.alert.alert-danger #{ error.message }
            .row
                .col-5
                    .card
                        .card-header
                            h3.card-title Card Info
                        form#addData(action="/dashboard/cards" method="post" role="form" autocomplete="off")
                            .card-body.row
                                input(type="hidden" name="_csrf" value=`${csrfToken}`)
                                .form-group.col-md-10
                                    label Card Number
                                    input.form-control#cardNum(type="text" name="cardNum" placeholder="Enter Card Number" oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);" maxlength = "19")
                                .form-group.col-md-10
                                    label Start Date
                                    #startDate.input-group.date(data-target-input='nearest')
                                        .input-group-append(data-target='#startDate' data-toggle='datetimepicker')
                                            .input-group-text
                                                i.fa.fa-calendar
                                        input.form-control.datetimepicker-input.startDate(type='text' name="startDate" data-target='#startDate' data-toggle='datetimepicker')
                                .form-group.col-md-10
                                    label End Date
                                    #endDate.input-group.date(data-target-input='nearest')
                                        .input-group-append(data-target='#endDate' data-toggle='datetimepicker')
                                            .input-group-text
                                                i.fa.fa-calendar
                                        input.form-control.datetimepicker-input.endDate(type='text' name="endDate" data-target='#endDate' data-toggle='datetimepicker')
                            .card-footer
                                button.btn.btn-primary.float-right(type="submit") Add Card

                .col-7
                    .card
                        .card-header
                            h3.card-title All Cards
                            .card-tools
                            form(action=`/dashboard/cards/searchResult`, method="post")
                                input(type="hidden" name="_csrf" value=`${csrfToken}`)
                                .input-group.input-group-sm.float-right(style="width: 150px;")
                                    if dataProvided
                                        input.form-control.float-right(type="text" name="table_search" placeholder="بحث")
                                    if tbSearch
                                        input.form-control.float-right(type="text", value = `${table_search}`, name="table_search" placeholder="بحث")
                                    .input-group-append
                                    button.btn.btn-default(type="submit")
                                        i.fas.fa-search
                        .card-body.table-responsive.p-0
                            table.table.table-sm.table-hover.text-nowrap
                                thead
                                    tr
                                        th ID
                                        th Card Number 
                                        th Start Date
                                        th End Date
                                        th Validity
                                        th تعديل
                                        th حذف
                                tbody
                                    if tbSearch
                                        - var num = 1
                                        for tb in tbSearch
                                            tr
                                                td #{num++}
                                                td #{tb.value}
                                                td #{tb.startDate.toJSON().slice(0,10).split('-').reverse().join('/')} 
                                                td #{tb.endDate.toJSON().slice(0,10).split('-').reverse().join('/')} 
                                                td 
                                                    if tb.endDate > dateNow
                                                        span.badge.badge-success
                                                            | valid
                                                    else
                                                        span.badge.badge-danger
                                                            | invalid
                                                td
                                                    a.btn-sm.btn-primary(href=`/dashboard/cards/edit/${tb.id}`)
                                                        i.far.fa-edit
                                                        |  تعديل
                                                td
                                                    form(action=`/dashboard/cards/delete/${tb.id}`, method="post")
                                                        input(type="hidden" name="_csrf" value=`${csrfToken}`)
                                                        button.btn-sm.btn-danger(type="submit")
                                                            i.far.fa-trash-alt
                                                            |  حذف
                                    if dataProvided
                                        - var datArray = dataProvided.docs
                                        - var hasPrev = dataProvided.hasPrevPage 
                                        - var hasNext = dataProvided.hasNextPage 
                                        - var totalPages = dataProvided.totalPages 
                                        - var pages = 1
                                        - var page = dataProvided.page 
                                        - var num = (page-1)*dataProvided.limit+1
                                        for dat in datArray
                                            tr
                                                td #{num++}
                                                td #{dat.value}
                                                td #{dat.startDate.toJSON().slice(0,10).split('-').reverse().join('/')} 
                                                td #{dat.endDate.toJSON().slice(0,10).split('-').reverse().join('/')}
                                                td 
                                                    if dat.endDate > dateNow
                                                        span.badge.badge-success
                                                            | valid
                                                    else
                                                        span.badge.badge-danger
                                                            | invalid
                                                td
                                                    a.btn-sm.btn-primary(href=`/dashboard/cards/edit/${dat.id}`)
                                                        i.far.fa-edit
                                                        |  تعديل
                                                td
                                                    form(action=`/dashboard/cards/delete/${dat.id}`, method="post")
                                                        input(type="hidden" name="_csrf" value=`${csrfToken}`)
                                                        button.btn-sm.btn-danger(type="submit")
                                                            i.far.fa-trash-alt
                                                            |  حذف
                        .card-footer.clearfix
                            ul.pagination.pagination-sm.m-0.float-right
                                if hasPrev
                                    li.page-item
                                        a.page-link(href=`/dashboard/cards?p=${page - 1}`) «

                                if totalPages > 1
                                    while pages  < 3            
                                        li.page-item
                                            if pages === page
                                                a.page-link.active( style="background-color:rgba(0,0,0,0.1); color:black;" )= pages
                                            else
                                                a.page-link.active( href=`/dashboard/cards?p=${pages}`)= pages

                                        - pages++    

                                if hasNext
                                    li.page-item
                                        a.page-link(href=`/dashboard/cards?p=${page + 1}`) »

    script. 
        var d = new Date();
        d.setHours(0,0,0,0);

block scripts 
    script(src="/static/vendor/js/addCard.js" type="text/javascript")
    script. 
        document.getElementById('cardNum').addEventListener('input', function (e) {
            var target = e.target, position = target.selectionEnd, length = target.value.length;

            target.value = target.value.replace(/[^\dA-Z]/g, '').replace(/(.{4})/g, '$1 ').trim();
            target.selectionEnd = position += ((target.value.charAt(position - 1) === ' ' && target.value.charAt(length - 1) === ' ' && length !== target.value.length) ? 1 : 0);
        });
    script. 
        $(function () {
            //Date range picker
            $('#endDate').datetimepicker({
                format: 'DD/MM/YYYY',  
                minDate:d
            });
            $('#startDate').datetimepicker({
                format: 'DD/MM/YYYY',       
                minDate:d
            });





        })



